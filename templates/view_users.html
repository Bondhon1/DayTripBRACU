<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
<title>Users</title>
<style>
  
  h2 { text-align: center;  }
  
  /* Search form in a single row */
  .search-form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 1rem;
    align-items: center;
  }
  .search-form input, .search-form select, .search-form button {
    padding: 0.5rem 0.75rem;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 0.95rem;
  }
  .search-form button {
    background: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  .search-form button:hover { background: #0056b3; }

  table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px #ccc; }
  th, td { padding: 0.75rem 0.5rem; border-bottom: 1px solid #eee; text-align: left; font-size: 0.95rem; }
  th { background: #007bff; color: #fff; }
  tr:hover { background: #f1f8ff; }

  .pagination { margin-top: 1rem; text-align: center; }
  .pagination a { margin: 0 0.5rem; text-decoration: none; color: #007bff; }
  .pagination a:hover { text-decoration: underline; }

  @media (max-width: 768px) {
    .search-form { flex-direction: column; gap: 0.5rem; }
  }
</style>
</head>
<body>

{% include 'navbar_private.html' %}
{% include 'flash.html' %}

<h2>Users</h2>

<form method="GET" class="search-form">
  <div class="search-row">
    <input type="text" name="full_name" placeholder="Full Name" value="{{ search_name }}">
    <input type="text" name="student_id" placeholder="Student ID" value="{{ search_student }}">
    <input type="text" name="email" placeholder="Email" value="{{ search_email }}">
    <input type="date" name="createdAt" value="{{ search_date }}">
    <select name="sort_by">
      <option value="createdAt" {% if sort_by=='createdAt' %}selected{% endif %}>Sort by Date</option>
      <option value="email" {% if sort_by=='email' %}selected{% endif %}>Sort by Email</option>
    </select>
    <select name="sort_order">
      <option value="asc" {% if sort_order=='asc' %}selected{% endif %}>Ascending</option>
      <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>Descending</option>
    </select>
    <button type="submit">Search</button>
  </div>
</form>

<style>
.search-form {
  display: flex;
  justify-content: center;
  margin-bottom: 1rem;
}

.search-row {
  display: flex;
  gap: 0.5rem;
  background: #fff;
  padding: 0.75rem 1rem;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  align-items: center;
  width: 100%;
  max-width: 1200px;
}

.search-row input,
.search-row select {
  flex: 1;
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.9rem;
}

.search-row input[type="date"] {
  flex: 1.2;
}

.search-row button {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  background-color: #007bff;
  color: white;
  cursor: pointer;
  transition: 0.2s;
  flex: 0 0 120px; /* fixed width button */
}

.search-row button:hover {
  background-color: #0056b3;
}

/* Responsive: wrap to multiple rows on small screens */
@media (max-width: 992px) {
  .search-row {
    flex-wrap: wrap;
  }
  .search-row button {
    flex: 1 1 100%;
  }
}
</style>



<table id="users-table">
  <thead>
    <tr>
      <th>Email</th>
      <th>Full Name</th>
      <th>Student ID</th>
      <th>Contact Number</th>
      <th>Guardian Contact</th>
      <th>Blood Group</th>
      <th>Completed Credit</th>
      <th>Joining Semester</th>
      <th>T-shirt Size</th>
      <th>Verified</th>
      <th>Role</th>
      <th>Created At</th>
        <th>Actions</th>
    </tr>
  </thead>
  <tbody>
        {% for u in users %}
        <tr>
        <td>{{ u.get('email','-') }}</td>
        <td>{{ u.get('full_name','-') }}</td>
        <td>{{ u.get('student_id','-') }}</td>
        <td>{{ u.get('contact_number','-') }}</td>
        <td>{{ u.get('guardian_contact','-') }}</td>
        <td>{{ u.get('blood_group','-') }}</td>
        <td>{{ u.get('completed_credit','-') }}</td>
        <td>{{ u.get('joining_semester','-') }}</td>
        <td>{{ u.get('t_shirt_size','-') }}</td>
        <td>{{ u.get('verified', False) }}</td>
        <td>{{ u.get('role','user') }}</td>
        <td>{{ u.get('createdAt','-') }}</td>
        <td>
            <button class="edit-user-btn" 
                    data-uid="{{ u.get('uid') }}"
                    data-email="{{ u.get('email') }}"
                    data-full_name="{{ u.get('full_name','') }}"
                    data-student_id="{{ u.get('student_id','') }}"
                    data-contact_number="{{ u.get('contact_number','') }}"
                    data-guardian_contact="{{ u.get('guardian_contact','') }}"
                    data-blood_group="{{ u.get('blood_group','') }}"
                    data-t_shirt_size="{{ u.get('t_shirt_size','') }}"
                    data-verified="{{ u.get('verified', False) }}">
            Edit
            </button>
        </td>
        </tr>
        {% endfor %}
        </tbody>

</table>

<div class="pagination">
  {% if page > 1 %}
    <a href="?page={{ page-1 }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&full_name={{ search_name }}&email={{ search_email }}&student_id={{ search_student }}&createdAt={{ search_date }}">Prev</a>
  {% endif %}
  Page {{ page }} of {{ total_pages }}
  {% if page < total_pages %}
    <a href="?page={{ page+1 }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&full_name={{ search_name }}&email={{ search_email }}&student_id={{ search_student }}&createdAt={{ search_date }}">Next</a>
  {% endif %}
</div>
<!-- Edit User Modal -->
<div id="editUserModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; overflow:auto;">
  <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; position:relative; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
    <h3 style="margin-top:0; text-align:center;">Edit User</h3>
    <form id="edit-user-form" style="display:flex; flex-direction:column; gap:0.8rem; max-height:80vh; overflow:auto;">
      <input type="hidden" name="uid" id="modal-uid">

      <label>Email:</label>
      <input type="text" id="modal-email" disabled style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">

      <label>Full Name:</label>
      <input type="text" id="modal-full_name" disabled style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">

      <label>Student ID:</label>
      <input type="text" name="student_id" id="modal-student_id" style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">

      <label>Contact Number:</label>
      <input type="text" name="contact_number" id="modal-contact_number" style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">

      <label>Guardian Contact:</label>
      <input type="text" name="guardian_contact" id="modal-guardian_contact" style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">

      <label>Blood Group:</label>
      <select name="blood_group" id="modal-blood_group" style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
        <option value="">-- Select --</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
      </select>

      <label>T-shirt Size:</label>
      <select name="t_shirt_size" id="modal-t_shirt_size" style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
        <option value="">-- Select --</option>
        <option value="XS">XS</option>
        <option value="S">S</option>
        <option value="M">M</option>
        <option value="L">L</option>
        <option value="XL">XL</option>
        <option value="XXL">XXL</option>
      </select>

      <label>Verified:</label>
      <select name="verified" id="modal-verified" style="width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;">
        <option value="true">True</option>
        <option value="false">False</option>
      </select>

      <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem;">
        <button type="button" id="modal-cancel" style="padding:0.5rem 1rem; background:#ccc; border:none; border-radius:5px; cursor:pointer;">Cancel</button>
        <button type="submit" style="padding:0.5rem 1rem; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const modal = document.getElementById('editUserModal');
const form = document.getElementById('edit-user-form');
const cancelBtn = document.getElementById('modal-cancel');

// Open modal and populate data
document.querySelectorAll('.edit-user-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    modal.style.display = 'flex';
    document.getElementById('modal-uid').value = btn.dataset.uid;
    document.getElementById('modal-email').value = btn.dataset.email;
    document.getElementById('modal-full_name').value = btn.dataset.full_name;
    document.getElementById('modal-student_id').value = btn.dataset.student_id;
    document.getElementById('modal-contact_number').value = btn.dataset.contact_number;
    document.getElementById('modal-guardian_contact').value = btn.dataset.guardian_contact;
    document.getElementById('modal-blood_group').value = btn.dataset.blood_group || '';
    document.getElementById('modal-t_shirt_size').value = btn.dataset.t_shirt_size || '';
    document.getElementById('modal-verified').value = btn.dataset.verified;
  });
});

// Close modal
cancelBtn.addEventListener('click', () => modal.style.display = 'none');

// Close modal when clicking outside
modal.addEventListener('click', e => {
  if(e.target === modal) modal.style.display = 'none';
});

// Submit updated user info
form.addEventListener('submit', async e => {
  e.preventDefault();
  const uid = document.getElementById('modal-uid').value;
  const data = {
    student_id: document.getElementById('modal-student_id').value,
    contact_number: document.getElementById('modal-contact_number').value,
    guardian_contact: document.getElementById('modal-guardian_contact').value,
    blood_group: document.getElementById('modal-blood_group').value,
    t_shirt_size: document.getElementById('modal-t_shirt_size').value,
    verified: document.getElementById('modal-verified').value === 'true'
  };

  const res = await fetch(`/update_user/${uid}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });

  if(res.ok) {
    alert('User updated successfully!');
    window.location.reload();
  } else {
    alert('Update failed!');
  }
});
</script>


</body>
</html>
